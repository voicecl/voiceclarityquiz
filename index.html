<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Voice Personalization Listening Quiz</title>
    <script>
    (function() {
        'use strict';
        
        // 🔒 SECURITY LEVEL 1: Environment Detection
        const isProduction = (
            window.location.hostname.includes('github.io') ||
            window.location.hostname.includes('voicecl.github.io') ||
            (window.location.hostname !== 'localhost' && 
             window.location.hostname !== '127.0.0.1' &&
             !window.location.hostname.includes('local'))
        );
        
        window.PRODUCTION_MODE = isProduction;
        
        if (!isProduction) {
            console.log('🔧 Development mode - full debugging available');
            return; // Exit early in development
        }
        
        console.log('🔒 Secure mode active');
        
        // 🔒 SECURITY LEVEL 2: Complete Console Lockdown
        const secureConsole = () => {
            const methods = ['log', 'warn', 'error', 'info', 'debug', 'trace', 'dir', 'table'];
            const originalMethods = {};
            
            methods.forEach(method => {
                originalMethods[method] = console[method];
                console[method] = (...args) => {
                    // Show only safe, generic messages
                    const safeArgs = args.map(arg => {
                        if (typeof arg === 'string') {
                            // Remove ALL potentially sensitive information
                            return arg
                                .replace(/\-?\d+\.?\d*\s*(cents|hz|khz)/gi, 'X units')
                                .replace(/formant\s+\d+\.?\d*/gi, 'formant X.X')
                                .replace(/\d+\-\d+(hz|khz)/gi, 'X-X Hz')
                                .replace(/(light|medium|deep|raw)/gi, 'mode')
                                .replace(/left\s*version|right\s*version/gi, 'version')
                                .replace(/🔹.*|🔸.*|🔴.*/gi, '🔊 Processing configured')
                                .replace(/version\s*(a|b|left|right):\s*\w+/gi, 'version: X')
                                .replace(/processing\s*(mode|type):\s*\w+/gi, 'processing: active')
                                .replace(/actualversion|selectedversion|trialtype/gi, 'data')
                                .replace(/superpowered.*initialization/gi, 'audio system ready');
                        }
                        return arg;
                    });
                    
                    // Only show truly safe messages
                    if (safeArgs.some(arg => 
                        typeof arg === 'string' && 
                        (arg.includes('ready') || 
                         arg.includes('initialized') || 
                         arg.includes('complete') ||
                         arg.includes('Processing configured') ||
                         arg.includes('audio system'))
                    )) {
                        originalMethods[method].apply(console, safeArgs);
                    }
                };
            });
            
            // Store originals for internal use if needed
            window._originalConsole = originalMethods;
        };
        
        // 🔒 SECURITY LEVEL 3: Disable Developer Tools Detection
        const blockDevTools = () => {
            // Detect dev tools opening
            let devtools = {
                open: false,
                orientation: null
            };
            
            setInterval(() => {
                if (window.outerHeight - window.innerHeight > 200 || 
                    window.outerWidth - window.innerWidth > 200) {
                    if (!devtools.open) {
                        devtools.open = true;
                        // Clear potentially sensitive data from console
                        console.clear();
                        console.log('🔒 Study in progress');
                    }
                } else {
                    devtools.open = false;
                }
            }, 500);
        };
        
        // 🔒 SECURITY LEVEL 4: Obfuscate Global Variables
        const secureGlobals = () => {
            // Override Object.keys, Object.getOwnPropertyNames for window
            const originalKeys = Object.keys;
            const originalProps = Object.getOwnPropertyNames;
            
            Object.keys = function(obj) {
                if (obj === window) {
                    // Hide sensitive global variables
                    return originalKeys(obj).filter(key => 
                        !key.includes('quiz') &&
                        !key.includes('voice') &&
                        !key.includes('trial') &&
                        !key.includes('debug') &&
                        !key.includes('processing')
                    );
                }
                return originalKeys(obj);
            };
            
            Object.getOwnPropertyNames = function(obj) {
                if (obj === window) {
                    return originalProps(obj).filter(key => 
                        !key.includes('quiz') &&
                        !key.includes('voice') &&
                        !key.includes('trial') &&
                        !key.includes('debug') &&
                        !key.includes('processing')
                    );
                }
                return originalProps(obj);
            };
        };
        
        // 🔒 SECURITY LEVEL 5: Network Request Obfuscation
        const secureNetwork = () => {
            // Override fetch to obfuscate sensitive data in network tab
            const originalFetch = window.fetch;
            window.fetch = function(url, options = {}) {
                if (options.body && typeof options.body === 'string') {
                    try {
                        const data = JSON.parse(options.body);
                        // Obfuscate sensitive fields in network requests
                        if (data.responses) {
                            data.responses = data.responses.map(response => ({
                                ...response,
                                actualVersion: response.actualVersion ? 'version_' + btoa(response.actualVersion).slice(0,6) : undefined,
                                trialType: response.trialType ? 'type_' + btoa(response.trialType).slice(0,6) : undefined,
                                selectedVersion: response.selectedVersion ? 'selected_' + btoa(response.selectedVersion).slice(0,6) : undefined
                            }));
                        }
                        options.body = JSON.stringify(data);
                    } catch (e) {
                        // If not JSON, leave as is
                    }
                }
                return originalFetch.call(this, url, options);
            };
        };
        
        // 🔒 SECURITY LEVEL 6: Context Menu and Keyboard Shortcuts
        const blockInspection = () => {
            // Disable right-click context menu
            document.addEventListener('contextmenu', e => {
                e.preventDefault();
                return false;
            });
            
            // Disable common dev tools shortcuts
            document.addEventListener('keydown', e => {
                // F12
                if (e.keyCode === 123) {
                    e.preventDefault();
                    return false;
                }
                // Ctrl+Shift+I
                if (e.ctrlKey && e.shiftKey && e.keyCode === 73) {
                    e.preventDefault();
                    return false;
                }
                // Ctrl+Shift+C
                if (e.ctrlKey && e.shiftKey && e.keyCode === 67) {
                    e.preventDefault();
                    return false;
                }
                // Ctrl+U (view source)
                if (e.ctrlKey && e.keyCode === 85) {
                    e.preventDefault();
                    return false;
                }
            });
        };
        
        // 🔒 ACTIVATE ALL SECURITY LAYERS
        secureConsole();
        blockDevTools();
        secureGlobals();
        secureNetwork();
        
        // Optional: More aggressive protection (can be annoying)
        // blockInspection();
        
        console.log('🔒 Multi-layer security active for blind testing');
        
    })();
    </script>
    
    <!-- 🔒 ADDITIONAL SECURITY: Meta tags to discourage caching -->
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script type="module">
      // ✅ CORRECT v2.7.2 ES6 Module Import
      import { SuperpoweredGlue, SuperpoweredWebAudio } from 'https://cdn.jsdelivr.net/npm/@superpoweredsdk/web@2.7.2';
      
      // Make available globally for other scripts
      window.SuperpoweredGlue = SuperpoweredGlue;
      window.SuperpoweredWebAudio = SuperpoweredWebAudio;
      
      console.log('✅ Superpowered v2.7.2 modules imported successfully');
    </script>
    <script>
      // Verify Superpowered v2.7.2 SDK loaded correctly
      window.addEventListener('load', function() {
        console.log('✅ Page loaded');
        setTimeout(() => {
          console.log('⏳ Verifying Superpowered v2.7.2 SDK presence...');
          console.log('🔎 SuperpoweredGlue:', window.SuperpoweredGlue);
          console.log('🔎 SuperpoweredWebAudio:', window.SuperpoweredWebAudio);
          console.log('🔎 Available Superpowered objects:', Object.keys(window).filter(k => k.toLowerCase().includes('super')));

          if (window.SuperpoweredGlue && window.SuperpoweredWebAudio) {
            console.log('✅ Superpowered v2.7.2 SDK loaded successfully');
          } else {
            console.error('❌ Superpowered v2.7.2 SDK failed to load');
            console.log('🔍 Check Network tab for: https://cdn.jsdelivr.net/npm/@superpoweredsdk/web@2.7.2');
          }
        }, 1000); // Give it 1 second to load
      });
    </script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="styles/main.css">
</head>
<body>
    <div id="app" class="app-container">
        <!-- Landing Page -->
        <div id="landing-page" class="screen active">
            <div class="text-center">
                <div class="text-4xl mb-4">🎙️</div>
                <h1 class="text-3xl font-bold mb-4">Voice Clarity Quiz</h1>
                <p class="text-aura-secondary mb-4 leading-relaxed">
                    Takes about 10 minutes - Record short responses and compare audio versions at your own pace
                </p>
                <p class="text-aura-secondary mb-8 leading-relaxed">
                    Which version of your answers sounds better to you?
                </p>
                <button id="start-quiz-btn" class="btn-primary mb-8">Start Quiz</button>
                
                <!-- Microphone Test Button -->
                <button id="test-microphone-btn" class="btn-secondary mb-4">Test Microphone</button>
                <div id="microphone-status" class="text-sm text-aura-secondary mb-4"></div>
                <div class="text-xs text-aura-secondary mb-4 italic">For best results, we recommend using Chrome or Firefox. Safari may experience audio processing limitations.</div>
                
                <div class="text-sm text-aura-secondary space-y-2">
                    <div>• 10 quick questions (≈10 minutes total)</div>
                    <div>• Record responses up to 15 seconds each</div>
                    <div>• Listen to processed versions (just a few seconds needed)</div>
                    <div>• Select which version sounds better to you</div>
                </div>
                <div class="text-xs text-aura-secondary mt-2 italic">
                    Listen to as much or as little as you need to make your choice
                </div>
            </div>
        </div>

        <!-- Simple Consent Page -->
        <div id="registration-page" class="screen">
            <div class="text-center max-w-md mx-auto">
                <div class="text-3xl mb-4">📋</div>
                <h2 class="text-2xl font-bold mb-2">Voice Research Study</h2>
                <p class="text-aura-secondary mb-4">Help us improve voice technology for everyone</p>
                <p class="text-sm text-aura-secondary mb-6 italic">This study takes about 10 minutes to complete</p>

                <!-- Voice Setup Instructions -->
                <div class="w-full max-w-2xl mx-auto mb-6 px-4 py-4 bg-gray-50 border border-gray-200 rounded-lg shadow-sm">
                  <h2 class="text-lg font-semibold text-gray-800 mb-3">🎤 Voice Setup Instructions</h2>
                  
                  <div class="grid grid-cols-1 md:grid-cols-2 gap-4 text-sm text-gray-700">
                    <div>
                      <p class="font-medium text-green-700 mb-1">✅ DO:</p>
                      <ul class="list-disc list-inside space-y-1">
                        <li>Use speakerphone or laptop mic</li>
                        <li>Stay about a foot away from the mic</li>
                        <li>Be in a quiet indoor environment</li>
                        <li>Speak clearly in a normal voice</li>
                      </ul>
                    </div>
                    <div>
                      <p class="font-medium text-red-700 mb-1">🚫 DON'T:</p>
                      <ul class="list-disc list-inside space-y-1">
                        <li>Use AirPods, Bluetooth, or earbuds</li>
                        <li>Hold the phone too close or too far</li>
                        <li>Whisper, shout, or change voice style</li>
                        <li>Record near fans, TVs, or windows</li>
                      </ul>
                    </div>
                  </div>
                </div>

                <!-- Simple Consent Form -->
                <form id="registration-form" class="space-y-4">
                    <!-- Consent Checkbox -->
                    <div class="consent-section">
                        <label for="consent" class="flex items-start space-x-3 text-left">
                            <input type="checkbox" id="consent" name="consent" required 
                                   class="consent-checkbox mt-1 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2">
                            <span class="text-sm text-aura-secondary">
                                I consent to participate in this anonymous voice study. My responses will be used for research purposes only.
                            </span>
                        </label>
                    </div>

                    <!-- Start Button -->
                    <button type="submit" id="register-btn" class="btn-primary w-full mt-6 mb-6">
                        Start Voice Quiz
                    </button>
                </form>
            </div>
        </div>

        <!-- Recording Page -->
        <div id="recording-page" class="screen">
            <div class="text-center">
                <!-- Progress Dots -->
                <div class="progress-dots">
                    <div class="progress-dot" data-question="0"></div>
                    <div class="progress-dot" data-question="1"></div>
                    <div class="progress-dot" data-question="2"></div>
                    <div class="progress-dot" data-question="3"></div>
                    <div class="progress-dot" data-question="4"></div>
                    <div class="progress-dot" data-question="5"></div>
                    <div class="progress-dot" data-question="6"></div>
                </div>

                <!-- Question Counter -->
                <div id="question-counter" class="text-aura-secondary mb-6">Question 1 of 7</div>

                <!-- Question Display -->
                <div id="question-text" class="question-text">What's your favorite place to relax and why?</div>
                <div id="question-hint" class="question-hint">Think about anywhere that feels perfect to you</div>

                <!-- Record Button -->
                <button id="record-btn" class="record-button mb-6">
                    <span id="record-icon">🎙️</span>
                </button>

                <!-- Status Text -->
                <div id="status-text" class="status-text">Tap to start</div>

                <!-- Timer -->
                <div id="timer" class="timer hidden">00:00</div>

                <!-- Progress Bar -->
                <div class="progress-bar mb-6">
                    <div id="recording-progress" class="progress-fill" style="width: 0%"></div>
                </div>

                <!-- Playback Controls (hidden initially) -->
                <div id="playback-controls" class="hidden flex gap-4 justify-center mt-6">
                    <button id="play-recording-btn" class="btn-secondary">Play Back Recording</button>
                    <button id="re-record-btn" class="btn-secondary">Re-record</button>
                    <button id="continue-btn" class="btn-primary">Continue</button>
                </div>

                <!-- Recording Complete Controls (hidden initially) -->
                <div id="recording-complete-controls" class="hidden">
                    <div class="text-center">
                        <div class="text-lg mb-4 text-success-green">✓ Recording Complete</div>
                        <div class="flex gap-4 justify-center">
                            <button id="restart-question-btn" class="btn-secondary">Restart Question</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Processing Page -->
        <div id="processing-page" class="screen">
            <div class="text-center">
                <div class="text-4xl mb-6">🎵 ⚡ 🎙️</div>
                <h2 class="text-2xl font-semibold mb-6">Creating your personalized<br>voice versions...</h2>
                
                <!-- Loading Bar -->
                <div class="loading-bar mb-4">
                    <div id="processing-progress" class="loading-fill"></div>
                </div>
                
                <div id="processing-status" class="text-aura-secondary mb-4">Processing question 1 of 7</div>
                <div class="text-sm text-aura-secondary">This may take a few moments</div>
            </div>
        </div>

        <!-- Comparison Page -->
        <div id="comparison-page" class="screen">
            <div class="text-center">
                <h2 class="text-2xl font-semibold mb-2">Choose Your Preferred Version</h2>
                <div id="comparison-question-counter" class="text-aura-secondary mb-6">Question 1 of 7</div>
                <div class="two-choice-grid">
                    <div class="choice-card" id="card-left">
                        <h3 class="font-semibold mb-2">Version A</h3>
                        <p class="text-sm text-aura-secondary mb-3 variant-label" id="label-left">&nbsp;</p>
                        <button class="play-button" id="play-left">▶️</button>
                        <button class="select-button" id="select-left">Choose A</button>
                        <div class="checkmark hidden">✓</div>
                    </div>
                    <div class="choice-card" id="card-right">
                        <h3 class="font-semibold mb-2">Version B</h3>
                        <p class="text-sm text-aura-secondary mb-3 variant-label" id="label-right">&nbsp;</p>
                        <button class="play-button" id="play-right">▶️</button>
                        <button class="select-button" id="select-right">Choose B</button>
                        <div class="checkmark hidden">✓</div>
                    </div>
                </div>
                <div id="waveform-section" class="mt-8 p-6 bg-aura-surface rounded-lg border border-aura-border">
                    <h3 class="text-lg font-semibold mb-4">Audio Visualization</h3>
                    <div class="waveform-container mb-4">
                        <canvas id="waveform-canvas" width="800" height="120" class="w-full h-32 bg-aura-background border border-aura-border rounded"></canvas>
                    </div>
                    <div id="playing-info" class="mt-4 text-center text-sm text-aura-secondary">
                        <span id="current-version">No audio playing</span>
                    </div>
                </div>

                <div id="feedback-section" class="opacity-50">
                    <h3 class="text-lg font-semibold mb-4">Why did you choose this version?</h3>
                    <div class="feedback-grid">
                        <label class="feedback-tag">
                            <input type="checkbox" name="reason" value="natural" disabled>
                            <span>Sounds most natural</span>
                        </label>
                        <label class="feedback-tag">
                            <input type="checkbox" name="reason" value="familiar" disabled>
                            <span>Feels familiar to me</span>
                        </label>
                        <label class="feedback-tag">
                            <input type="checkbox" name="reason" value="clear" disabled>
                            <span>Clearest to listen to</span>
                        </label>
                        <label class="feedback-tag">
                            <input type="checkbox" name="reason" value="warm" disabled>
                            <span>Warm and pleasant</span>
                        </label>
                        <label class="feedback-tag">
                            <input type="checkbox" name="reason" value="confident" disabled>
                            <span>Makes me sound confident</span>
                        </label>
                        <label class="feedback-tag">
                            <input type="checkbox" name="reason" value="myself" disabled>
                            <span>Sounds like how I think I sound</span>
                        </label>
                    </div>
                    <textarea id="feedback-comment" class="feedback-textarea" placeholder="Optional: Tell us more..." rows="3" disabled></textarea>
                    <button id="submit-feedback" class="btn-primary mt-4" disabled>Submit Feedback & Continue</button>
                </div>
            </div>
        </div>

        <!-- Results Page -->
        <div id="results-page" class="screen">
            <div class="text-center">
                <div class="text-4xl mb-6">🎉 ✨</div>
                <h2 class="text-2xl font-semibold mb-6">Personalization Complete!</h2>
                <div class="mb-6">
                    <p class="text-aura-secondary mb-2">Your preferred voice setting:</p>
                    <div id="preferred-version" class="text-xl font-semibold text-primary-blue mb-2">Version C</div>
                    <div id="preferred-description" class="text-aura-secondary">"Version C"</div>
                </div>
                <div class="mb-8">
                    <p class="text-aura-secondary mb-3">Most selected reasons:</p>
                    <div id="top-reasons" class="space-y-1 text-sm">
                        <div>• Sounds most natural</div>
                        <div>• Matches my inner voice</div>
                        <div>• Makes me sound confident</div>
                    </div>
                </div>
                <p class="text-aura-secondary mb-6">Your voice profile has been saved successfully</p>
                
                <!-- Voice Preference Summary -->
                <div id="voice-preference-summary" class="text-aura-primary text-lg mt-4 text-center"></div>
                
                <div class="flex gap-4 justify-center">
                    <button id="start-new-quiz-btn" class="btn-primary">Start New Quiz</button>
                </div>
            </div>
        </div>

        <!-- Thank You Screen -->
        <div id="thankyou-screen" class="hidden flex flex-col items-center justify-center py-16">
          <div class="text-6xl mb-4">🎉</div>
          <h2 class="text-3xl font-bold mb-2">Mission complete! 🎉</h2>
          <p class="text-lg text-gray-300 mb-4">
            Your 10 audio choices are now helping us improve voice technology.
          </p>
          <p class="text-lg text-gray-300 mb-6">
            Every ear is different - that's what makes this so valuable!
          </p>
          
          <p class="text-sm text-white mb-2">
            Your voice recordings have been automatically deleted for your privacy protection.
          </p>
          <p class="text-sm text-white">
            You may close this window or return to the homepage.
          </p>
        </div>
    </div>

    <!-- ✅ FIXED: Scripts - Proper loading order with ES6 modules -->
    <!-- Load non-module scripts first -->
    <script src="scripts/user-manager.js"></script>
    <script src="scripts/webhook-service.js"></script>
    <script src="scripts/ui-controller.js"></script>
    <script src="scripts/device-aware.js"></script>
    <script src="scripts/audio-format-fix.js"></script>
    
    <!-- ✅ Load ES6 modules after dependencies are ready -->
    <script type="module" src="scripts/audio-recorder.js"></script>
    <script type="module" src="scripts/audio-processor.js"></script>
    <script type="module" src="scripts/research-audio-processor.js"></script>
    
    <!-- ✅ Load main app last as ES6 module to ensure all dependencies are ready -->
    <script type="module" src="scripts/app-simple.js"></script>
</body>
</html>
